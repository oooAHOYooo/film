<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Storyboard - Creatures in the Tall Grass</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="storyboard.css?v=20260205-1">
  </head>
  <body>
    <div class="storyboard-layout">
      <aside class="film-rail">
        <h2>Films</h2>
        <div class="film-list">
          <div class="film-item active">Creatures in the Tall Grass</div>
        </div>
      </aside>

      <main class="storyboard-main">
        <div class="storyboard-sticky-bar">
          <div class="nav">
            <div class="nav-left">
              <span class="nav-title">Storyboard Reader</span>
              <a class="nav-link" href="/index.html">Home</a>
              <a class="nav-link" href="/pages/summer.html">Summer</a>
              <a class="nav-link" href="index.html">Gallery</a>
              <a class="nav-link" href="/pages/summer/characters/index.html">Characters</a>
            </div>
          </div>
          <div class="storyboard-meta-bar">
            <div class="scene-status" id="sceneStatus">Scene 1 of 1</div>
            <div class="scene-subtext" id="sceneSubtext">Loading scenes...</div>
            <div class="scene-nav">
              <label for="sceneSelect">Jump to scene</label>
              <select id="sceneSelect" class="scene-select">
                <option value="">-</option>
              </select>
            </div>
          </div>
          <div class="progress">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <header class="storyboard-header">
          <h1>Creatures in the Tall Grass - Storyboard</h1>
          <p>Anamorphic 2.39:1 frames with editable captions and shot details.</p>
        </header>

        <div class="storyboard-content" id="storyboardContent">
          Loading storyboard...
        </div>
      </main>
    </div>

    <script>
      const META_ORDER = ['Action', 'Camera', 'Movement', 'Lens', 'Lighting', 'Sound', 'Notes'];

      function parseSceneMarkdown(markdown) {
        const scene = { meta: {}, shots: [] };

        const firstShotIdx = markdown.search(/^### Shot/m);
        const metaBlock = firstShotIdx === -1 ? markdown : markdown.slice(0, firstShotIdx);
        metaBlock.split('\n').forEach((line) => {
          const match = line.match(/^-+\s*([A-Za-z ]+):\s*(.+)$/);
          if (match) scene.meta[match[1].trim()] = match[2].trim();
        });

        const shotRegex = /^### Shot\s+(\d+)\s*-\s*(.+)$/gm;
        const shotMatches = Array.from(markdown.matchAll(shotRegex));

        shotMatches.forEach((shotMatch, shotIndex) => {
          const shotStart = shotMatch.index + shotMatch[0].length;
          const shotEnd = (shotIndex + 1 < shotMatches.length) ? shotMatches[shotIndex + 1].index : markdown.length;
          const shotBlock = markdown.slice(shotStart, shotEnd);
          const headingParts = shotMatch[2].split(' - ').map((p) => p.trim()).filter(Boolean);
          const size = headingParts[0] || '';
          const shotTitle = headingParts.slice(1).join(' - ');
          const details = [];

          shotBlock.split('\n').forEach((line) => {
            const detailMatch = line.match(/^-+\s*([A-Za-z ]+):\s*(.+)$/);
            if (detailMatch) {
              details.push({ key: detailMatch[1].trim(), value: detailMatch[2].trim() });
            }
          });

          const detailMap = details.reduce((acc, item) => {
            acc[item.key.toLowerCase()] = item.value;
            return acc;
          }, {});

          scene.shots.push({
            number: parseInt(shotMatch[1], 10),
            size,
            title: shotTitle,
            caption: detailMap.caption || detailMap.action || '',
            details
          });
        });

        return scene;
      }

      function renderStoryboard(manifest, sceneData) {
        const container = document.getElementById('storyboardContent');
        container.innerHTML = '';

        manifest.forEach((entry, index) => {
          const sceneNumber = index + 1;
          const parsed = sceneData[index];

          const section = document.createElement('section');
          section.className = 'storyboard-scene';
          section.id = `scene-${sceneNumber}`;

          const headingRow = document.createElement('div');
          headingRow.className = 'scene-heading-row';

          const heading = document.createElement('h2');
          heading.textContent = `Scene ${sceneNumber}: ${entry.title}`;
          headingRow.appendChild(heading);

          const viewLink = document.createElement('a');
          viewLink.href = `scene.html?id=${entry.id}`;
          viewLink.className = 'scene-view-link';
          viewLink.textContent = 'View Scene';
          headingRow.appendChild(viewLink);

          section.appendChild(headingRow);

          const meta = document.createElement('div');
          meta.className = 'scene-meta';
          if (parsed.meta.Setting) {
            const span = document.createElement('span');
            span.className = 'scene-setting';
            span.textContent = parsed.meta.Setting;
            meta.appendChild(span);
          }
          if (parsed.meta.Beat) {
            const span = document.createElement('span');
            span.textContent = parsed.meta.Beat;
            meta.appendChild(span);
          }
          section.appendChild(meta);

          const shotList = document.createElement('div');
          shotList.className = 'shot-list';

          const SHOTS_PER_PAGE = 6;
          let pageEl = null;

          parsed.shots.forEach((shot, shotIdx) => {
            if (shotIdx % SHOTS_PER_PAGE === 0) {
              pageEl = document.createElement('div');
              pageEl.className = 'shot-page';
              shotList.appendChild(pageEl);
            }

            const card = document.createElement('div');
            card.className = 'shot-card';

            const header = document.createElement('div');
            header.className = 'shot-header';
            const title = document.createElement('div');
            title.className = 'shot-title';
            title.textContent = `Shot ${shot.number}${shot.title ? `: ${shot.title}` : ''}`;
            const badge = document.createElement('div');
            badge.className = 'shot-badge';
            badge.textContent = shot.size || 'SHOT';
            header.appendChild(title);
            header.appendChild(badge);
            card.appendChild(header);

            const frame = document.createElement('div');
            frame.className = 'shot-frame';
            const frameLabel = document.createElement('div');
            frameLabel.className = 'frame-label';
            frameLabel.textContent = shot.size || 'FRAME';
            const frameMode = document.createElement('div');
            frameMode.className = 'frame-mode';
            frameMode.textContent = '2.39:1';
            frame.appendChild(frameLabel);
            frame.appendChild(frameMode);
            card.appendChild(frame);

            const caption = document.createElement('div');
            caption.className = 'shot-caption';
            caption.textContent = shot.caption || 'Caption to be added.';
            card.appendChild(caption);

            const metaWrap = document.createElement('div');
            metaWrap.className = 'shot-meta';
            META_ORDER.forEach((key) => {
              const found = shot.details.find((d) => d.key.toLowerCase() === key.toLowerCase());
              if (!found) return;
              const span = document.createElement('span');
              span.textContent = `${found.key}: ${found.value}`;
              metaWrap.appendChild(span);
            });
            shot.details.forEach((detail) => {
              if (META_ORDER.some((key) => key.toLowerCase() === detail.key.toLowerCase())) return;
              if (detail.key.toLowerCase() === 'caption') return;
              const span = document.createElement('span');
              span.textContent = `${detail.key}: ${detail.value}`;
              metaWrap.appendChild(span);
            });
            card.appendChild(metaWrap);

            pageEl.appendChild(card);
          });

          section.appendChild(shotList);
          container.appendChild(section);
        });
      }

      function initSceneNav(manifest) {
        const select = document.getElementById('sceneSelect');
        select.innerHTML = '<option value="">-</option>';
        manifest.forEach((entry, index) => {
          const option = document.createElement('option');
          option.value = `scene-${index + 1}`;
          option.textContent = `${index + 1}. ${entry.title}`;
          select.appendChild(option);
        });

        select.addEventListener('change', function() {
          const target = document.getElementById(this.value);
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          this.value = '';
        });
      }

      function initStatusBar(manifest) {
        const statusEl = document.getElementById('sceneStatus');
        const subtextEl = document.getElementById('sceneSubtext');
        const progressFill = document.getElementById('progressFill');

        function updateStatus() {
          const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
          const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
          const progress = scrollHeight > 0 ? Math.min(1, Math.max(0, scrollTop / scrollHeight)) : 0;
          progressFill.style.width = `${progress * 100}%`;

          let currentIndex = 0;
          manifest.forEach((_, index) => {
            const el = document.getElementById(`scene-${index + 1}`);
            if (!el) return;
            const top = el.getBoundingClientRect().top;
            if (top <= 180) currentIndex = index;
          });

          const currentScene = manifest[currentIndex];
          if (currentScene) {
            statusEl.textContent = `Scene ${currentIndex + 1} of ${manifest.length}`;
            subtextEl.textContent = currentScene.title;
          }
        }

        updateStatus();
        window.addEventListener('scroll', updateStatus, { passive: true });
        window.addEventListener('resize', updateStatus);
      }

      async function initStoryboard() {
        try {
          // Load manifest
          const manifestResponse = await fetch('manifest.json');
          const manifest = await manifestResponse.json();

          // Load all scene files in parallel
          const scenePromises = manifest.map((entry) =>
            fetch(`scenes/${entry.file}`).then((r) => r.text())
          );
          const sceneTexts = await Promise.all(scenePromises);
          const sceneData = sceneTexts.map(parseSceneMarkdown);

          renderStoryboard(manifest, sceneData);
          initSceneNav(manifest);
          initStatusBar(manifest);
        } catch (error) {
          const container = document.getElementById('storyboardContent');
          container.textContent = 'Unable to load storyboard.';
          console.error(error);
        }
      }

      initStoryboard();
    </script>
  </body>
</html>
